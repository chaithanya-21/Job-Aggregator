<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Job Aggregator</title>

<!-- pdf-lib -->
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<style>
body{font-family:Segoe UI;background:#eef3f8;margin:0}
.container{max-width:900px;margin:auto;padding:30px}
.card{background:white;border-radius:8px;padding:25px;margin-top:40px;
box-shadow:0 2px 8px rgba(0,0,0,0.08)}
.job{background:white;border-radius:8px;padding:18px;margin-bottom:14px;
box-shadow:0 2px 6px rgba(0,0,0,0.08)}
.title{font-weight:600;font-size:18px}
.small{font-size:14px;color:#555;margin-top:4px}
button{margin-top:10px;padding:10px 14px;border:none;border-radius:5px;
background:#0a66c2;color:white;cursor:pointer}
button:hover{background:#004182}
.hidden{display:none}
</style>
</head>

<body>

<div class="container">

<!-- Upload screen -->
<div id="uploadScreen" class="card">
<h2>Upload Your Resume (PDF)</h2>
<input type="file" id="resumeFile" accept=".pdf">
<p id="status"></p>
<button onclick="continueToJobs()">Continue to Job Search</button>
</div>

<!-- Jobs screen -->
<div id="jobScreen" class="hidden">
<h2>Available Jobs</h2>
<div id="jobs"></div>
</div>

</div>

<script>

let resumeBytes=null;

/* Upload resume */
document.getElementById("resumeFile").addEventListener("change", async e=>{
resumeBytes=await e.target.files[0].arrayBuffer();
status.innerText="Resume uploaded âœ”";
});

/* Navigate */
function continueToJobs(){
uploadScreen.classList.add("hidden");
jobScreen.classList.remove("hidden");
loadJobs();
}

/* Load jobs */
async function loadJobs(){

const res=await fetch("/api/jobs");
const jobs=await res.json();

const container=document.getElementById("jobs");
container.innerHTML="";

jobs.forEach(j=>{

const card=document.createElement("div");
card.className="job";

card.innerHTML=`
<div class="title">${j.title}</div>
<div class="small">${j.company}</div>
<div class="small">${j.location}</div>
<div class="small">Salary: ${j.salary}</div>
<div class="small"><b>Skills Needed:</b> ${j.skills}</div>

<br>

<a href="${j.source}" target="_blank">
<button>Apply to Job</button>
</a>

<button onclick="generateATSResume('${encodeURIComponent(j.skills)}')">
Download ATS Optimized Resume
</button>

`;

container.appendChild(card);

});

}

/* ATS-safe resume generator */
async function generateATSResume(skillsEncoded){

if(!resumeBytes){
alert("Upload resume first");
return;
}

const skills=decodeURIComponent(skillsEncoded);

const { PDFDocument, StandardFonts, rgb } = PDFLib;

const existingPdf = await PDFDocument.load(resumeBytes);
const pages = existingPdf.getPages();

// Add new page
const newPage = existingPdf.addPage();
const { width, height } = newPage.getSize();

const font = await existingPdf.embedFont(StandardFonts.Helvetica);
const fontSize = 12;

const text = "Additional Relevant Skills:\n\n"+skills;

const wrapped = text.match(/.{1,90}/g);

let y = height - 40;
wrapped.forEach(line=>{
newPage.drawText(line,{
x:40,
y:y,
size:fontSize,
font,
color:rgb(0,0,0)
});
y -= 18;
});

const pdfBytes = await existingPdf.save();

const blob = new Blob([pdfBytes], { type: "application/pdf" });
const link = document.createElement("a");
link.href = URL.createObjectURL(blob);
link.download = "ATS_Optimized_Resume.pdf";
link.click();

}

</script>

</body>
</html>
